<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Blackjack Endiorite</title>
<style>
*{box-sizing:border-box;}
body{margin:0;min-height:100vh;background:radial-gradient(circle at top,#0f172a,#020617);font-family:system-ui,Arial,sans-serif;color:#f0f9ff;display:flex;justify-content:center;align-items:center;padding:20px;}
.card{width:100%;max-width:420px;background:#0b1120;border-radius:16px;padding:24px;border:1px solid #1e3a8a;box-shadow:0 10px 40px rgba(0,0,0,0.8),0 0 20px rgba(30,58,138,0.2);}
h1,h2,h3{text-align:center;margin:12px 0;color:#60a5fa;}
h1{font-size:1.8rem;}
input{width:100%;padding:14px;margin:8px 0;border-radius:10px;border:1px solid #1e293b;background:#020617;color:#bfdbfe;font-size:16px;}
input:focus{border-color:#3b82f6;box-shadow:0 0 8px rgba(59,130,246,0.3);}
button{width:100%;padding:14px;margin-top:10px;border:none;border-radius:10px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#fff;font-weight:700;font-size:16px;cursor:pointer;transition:0.2s;}
button:hover{opacity:.9;}
button:active{transform:scale(0.98);}
.secondary{background:#1e293b;color:#94a3b8;border:1px solid #334155;}
.msg{text-align:center;color:#7dd3fc;font-size:14px;margin:10px 0;min-height:20px;}
.credit-box{text-align:center;font-size:24px;font-weight:bold;margin:15px 0;color:#3b82f6;text-shadow:0 0 10px rgba(59,130,246,0.4);}
.card .cards{display:flex;justify-content:center;gap:10px;margin:10px 0;font-size:32px;}
.card .total{font-size:18px;text-align:center;margin-bottom:10px;color:#bfdbfe;}
.card input{margin-bottom:0;}
</style>
</head>
<body>

<div class="card">
<h1>üÉè Blackjack</h1>
<div class="credit-box">üí∞ <span id="credits">0</span> cr√©dits</div>

<input id="bet" type="number" placeholder="Mise (max 150)">
<div style="display:flex;gap:10px;">
<button id="startBtn">‚ñ∂ D√©marrer</button>
<button id="hitBtn" class="secondary" disabled>‚ûï Tirer</button>
<button id="standBtn" class="secondary" disabled>‚úã Rester</button>
</div>

<h3>Dealer</h3>
<div class="cards" id="dealerCards">‚ùì ‚ùì</div>

<h3>Joueur</h3>
<div class="cards" id="playerCards"></div>
<div class="total" id="playerTotal"></div>

<div class="msg" id="resultMsg"></div>
<button id="backBtn" class="secondary">‚¨Ö Retour</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDAQALLN99kqiYY4UZz9wl2stedP5KQ5mA",
  authDomain: "casino-b23c9.firebaseapp.com",
  databaseURL: "https://casino-b23c9-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "casino-b23c9",
  storageBucket: "casino-b23c9.appspot.com",
  messagingSenderId: "139229793155",
  appId: "1:139229793155:web:953b31b383a87bc3c504b6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Utilisateur
const currentUser = localStorage.getItem("casinoUser");
if(!currentUser){
  alert("Vous devez vous connecter !");
  window.location.href="https://kikoco16.github.io/Casino-Endiorite/";
}

// DOM
const creditsEl = document.getElementById("credits");
const betInput = document.getElementById("bet");
const startBtn = document.getElementById("startBtn");
const hitBtn = document.getElementById("hitBtn");
const standBtn = document.getElementById("standBtn");
const dealerCardsDiv = document.getElementById("dealerCards");
const playerCardsDiv = document.getElementById("playerCards");
const playerTotalDiv = document.getElementById("playerTotal");
const resultMsg = document.getElementById("resultMsg");
const backBtn = document.getElementById("backBtn");

let deck=[], playerCards=[], dealerCards=[], bet=0;

const suits = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
const values = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

function createDeck(){
  const d=[];
  for(let s of suits){
    for(let v of values) d.push(v+s);
  }
  return d.sort(()=>Math.random()-0.5);
}

function handValue(hand){
  let total=0, aces=0;
  for(let c of hand){
    let v=c.slice(0,-1);
    if(v==="A"){total+=11; aces++;}
    else if(["J","Q","K"].includes(v)) total+=10;
    else total+=parseInt(v);
  }
  while(total>21 && aces>0){total-=10; aces--;}
  return total;
}

async function refreshCredits(){
  const snap = await get(ref(db,"users/"+currentUser));
  creditsEl.textContent = snap.val().credits;
}

function updatePlayerTotal(){
  playerTotalDiv.textContent = "Total: "+handValue(playerCards);
}

// D√©marrer partie
// D√©marrer partie
async function startGame(){
  bet = Number(betInput.value);
  if(bet>150) bet=150;
  const snap = await get(ref(db,"users/"+currentUser));
  if(bet<=0 || bet>snap.val().credits){
    resultMsg.textContent="Mise invalide";
    return;
  }

  deck = createDeck();
  playerCards = [deck.pop(), deck.pop()];
  dealerCards = [deck.pop(), deck.pop()];

  dealerCardsDiv.textContent = dealerCards[0]+" ‚ùì";
  playerCardsDiv.textContent = playerCards.join(" ");
  updatePlayerTotal();

  startBtn.disabled=true; 
  
  // V√âRIFICATION BLACKJACK IMM√âDIAT (21)
  if(handValue(playerCards) === 21) {
    hitBtn.disabled=true; 
    standBtn.disabled=true;
    endGame(true); // On passe un argument 'true' pour signaler le Blackjack
  } else {
    hitBtn.disabled=false; 
    standBtn.disabled=false;
    resultMsg.textContent="";
  }
}




// Tirer carte
function hit(){
  playerCards.push(deck.pop());
  playerCardsDiv.textContent = playerCards.join(" ");
  updatePlayerTotal();
  if(handValue(playerCards)>21){
    endGame();
  }
}

// Rester
function stand(){
  endGame();
}

// Modifiez la signature de endGame pour accepter l'argument isBlackjack
async function endGame(isBlackjack = false){
  while(handValue(dealerCards)<17) dealerCards.push(deck.pop());

  const playerTotal = handValue(playerCards);
  const dealerTotal = handValue(dealerCards);
  
  dealerCardsDiv.innerHTML = `${dealerCards.join(" ")} <div style="font-size:18px; color:#bfdbfe; margin-top:5px;">Total: ${dealerTotal}</div>`;

  let gainFinal = 0;
  let message = "";

  // Nouvelle condition pour le x3
  if (isBlackjack) {
    gainFinal = bet * 3;
    message = `BLACKJACK ! üÉè‚ú® ‚Üí +${gainFinal} cr√©dits`;
  } 
  else if (playerTotal > 21) {
    gainFinal = -bet;
    message = `Vous avez d√©pass√© 21 üò¢ ‚Üí -${bet} cr√©dits`;
  } 
  else if (dealerTotal > 21 || playerTotal > dealerTotal) {
    gainFinal = Math.floor(bet * 1.5);
    message = `Gagn√© ! üî• ‚Üí +${gainFinal} cr√©dits`;
  } 
  else if (playerTotal === dealerTotal) {
    gainFinal = 0;
    message = `√âgalit√© ü§ù ‚Üí Mise rendue`;
  } 
  else {
    gainFinal = -bet;
    message = `Perdu üò¢ ‚Üí -${bet} cr√©dits`;
  }

  const snap = await get(ref(db,"users/"+currentUser));
  const credits = snap.val().credits;

  await update(ref(db,"users/"+currentUser),{
    credits: credits + gainFinal,
    balance: (snap.val().balance || 0) + gainFinal,
    password: snap.val().password
  });

  refreshCredits();
  resultMsg.textContent = message;

  startBtn.disabled=false; hitBtn.disabled=true; standBtn.disabled=true;
}

startBtn.onclick=startGame;
hitBtn.onclick=hit;
standBtn.onclick=stand;
backBtn.onclick=()=>window.location.href="https://kikoco16.github.io/Casino-Endiorite/";

refreshCredits();
</script>
</body>
</html>
